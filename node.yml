- name: Demo on nodes
  hosts: all
  tasks:
    - name: Find the URL of Node_Exporter Latest Version URL
      shell: curl -L -s https://prometheus.io/download/  | grep tar | grep node_exporter | grep linux-amd64  | sed -e "s|>| |g" -e 's|<| |g' -e 's|"| |g' |xargs -n1 | grep ^http
      register: node_exporter_url
    - name: debug
      debug:
        msg: "{{ node_exporter_url}}"
    - name: Grab filename and Directory Name from the URL
      set_fact:
          FILENAME: "{{node_exporter_url.stdout.split('/') | last}}"
          DIRNAME: "{{ FILENAME | regex_replace('.tar.gz', '')  }}"

    - name: debug
      debug:
       msg: "{{FILENAME}} , {{DIRNAME}}"
    - name: Download Node Exporter
      unarchive:
        src: "{{node_exporter_url.stdout}}"
        dest: /opt
        remote_src: yes
